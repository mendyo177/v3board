<!-- 自定义节点导入按钮注入脚本 -->
<script>(function(){const FORCE_VERSION='v1.0.2-'+Date.now();console.log('[custom-nodes] injector start',FORCE_VERSION);const securePath=(window.settings&&window.settings.secure_path)?String(window.settings.secure_path).replace(/^\/+/,'').replace(/\/+$/,''):'';const base=securePath?'/'+securePath:'';function onServerManage(){const p=location.pathname.replace(/\/+$/,'');const h=location.hash||'';if(/#[\/]?server\/manage(?:\/|$)/i.test(h))return true;return /\/server\/manage(?:\/|$)/i.test(p);}function createBtn(ref){const a=document.createElement('a');a.textContent='自定义节点导入';a.href=base+'/server/custom-nodes';a.id='custom-nodes-entry';a.target='_blank';a.rel='noopener noreferrer';a.className=ref&&ref.className?ref.className:'ant-btn ant-btn-default ant-btn-sm';a.style.marginLeft='8px';a.title='批量导入原样节点 - '+FORCE_VERSION;return a;}function findSortButton(){const els=Array.from(document.querySelectorAll('button,a'));const cands=[/编辑排序/,/调整排序/,/排序/,/Sort/i];return els.find(el=>{const t=(el.textContent||'').replace(/\s+/g,'').trim();return cands.some(re=>re.test(t));})||null;}function removeEntry(){const exist=document.getElementById('custom-nodes-entry');if(exist&&exist.parentElement){try{exist.parentElement.removeChild(exist);console.log('[custom-nodes] remove old button');}catch(e){}}}function tryInject(){if(!onServerManage()){removeEntry();return;}removeEntry();const sortBtn=findSortButton();const entry=createBtn(sortBtn);if(sortBtn){try{sortBtn.insertAdjacentElement('afterend',entry);console.log('[custom-nodes] injected near sort button');return;}catch(e){console.warn('[custom-nodes] cannot insert near sort',e);}}const header=document.querySelector('[class*="ant-page-header"],[class*="ant-card-extra"],[class*="ant-space"],#root');try{(header||document.body).insertAdjacentElement('afterbegin',entry);console.log('[custom-nodes] injected header');}catch(e){(header||document.body).appendChild(entry);console.log('[custom-nodes] injected fallback bottom');}}let lastPath=location.pathname,lastHash=location.hash;setInterval(()=>{let changed=false;if(location.pathname!==lastPath){lastPath=location.pathname;changed=true;}if(location.hash!==lastHash){lastHash=location.hash;changed=true;}if(changed){console.log('[custom-nodes] route change reinject');removeEntry();[50,250,800].forEach(d=>setTimeout(tryInject,d));}},300);window.addEventListener('hashchange',()=>{console.log('[custom-nodes] hash change reinject');removeEntry();[50,250,800].forEach(d=>setTimeout(tryInject,d));});const mo=new MutationObserver(()=>{if(!document.getElementById('custom-nodes-entry')&&onServerManage()){tryInject();}});mo.observe(document.documentElement,{subtree:true,childList:true});window.addEventListener('DOMContentLoaded',()=>{console.log('[custom-nodes] DOMContentLoaded inject');tryInject();});setTimeout(()=>{console.log('[custom-nodes] delayed inject');tryInject();},800);tryInject();console.log('[custom-nodes] injector ready');})();</script>