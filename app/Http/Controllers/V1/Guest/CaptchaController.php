<?php\r\n\r\nnamespace App\\Http\\Controllers\\V1\\Guest;\r\n\r\nuse App\\Http\\Controllers\\Controller;\r\nuse App\\Services\\LocalCaptchaService;\r\nuse Illuminate\\Http\\Request;\r\n\r\nclass CaptchaController extends Controller\r\n{\r\n    public function image(Request $request)\r\n    {\r\n        $code = null;\r\n        try {\r\n            $code = LocalCaptchaService::generateCode($request);\r\n        } catch (\\Throwable $e) {\r\n            \\Log::error('Captcha generation/session failed: ' . $e->getMessage());\r\n        }\r\n        $code = $code ?: 'AB12C';\r\n        try {\r\n            if ($code === 'AB12C' && $request->hasSession() && !$request->session()->has('captcha_code')) {\r\n                $request->session()->put('captcha_code', strtolower($code));\r\n                $request->session()->put('captcha_time', time());\r\n            }\r\n        } catch (\\Throwable $e) {\r\n            \\Log::warning('Captcha fallback store failed: ' . $e->getMessage());\r\n        }\r\n        if (function_exists('imagecreatetruecolor')) {\r\n            try {\r\n                $png = LocalCaptchaService::renderImage($code);\r\n                return response($png, 200, [\r\n                    'Content-Type' => 'image/png',\r\n                    'Cache-Control' => 'no-store, no-cache, must-revalidate, max-age=0',\r\n                    'Pragma' => 'no-cache',\r\n                    'Expires' => '0',\r\n                ]);\r\n            } catch (\\Throwable $e) {\r\n                \\Log::error('Captcha PNG render failed: ' . $e->getMessage());\r\n            }\r\n        }\r\n        $svg = LocalCaptchaService::renderSvg($code);\r\n        return response($svg, 200, [\r\n            'Content-Type' => 'image/svg+xml',\r\n            'Cache-Control' => 'no-store, no-cache, must-revalidate, max-age=0',\r\n            'Pragma' => 'no-cache',\r\n            'Expires' => '0',\r\n        ]);\r\n    }\r\n}\r\n