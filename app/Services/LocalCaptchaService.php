<?php\r\n\r\nnamespace App\\Services;\r\n\r\nuse Illuminate\\Http\\Request;\r\n\r\nclass LocalCaptchaService\r\n{\r\n    public static function generateCode(Request $request, int $length = 5): string\r\n    {\r\n        $pool = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';\r\n        $code = '';\r\n        for ($i = 0; $i < $length; $i++) {\r\n            $code .= $pool[random_int(0, strlen($pool) - 1)];\r\n        }\r\n        $request->session()->put('captcha_code', strtolower($code));\r\n        $request->session()->put('captcha_time', time());\r\n        return $code;\r\n    }\r\n\r\n    public static function verify(Request $request, ?string $input): bool\r\n    {\r\n        if (!$input) return false;\r\n        $expected = $request->session()->get('captcha_code');\r\n        if (!$expected) return false;\r\n        $ok = strtolower(trim($input)) === $expected;\r\n        if ($ok) {\r\n            $request->session()->forget(['captcha_code', 'captcha_time']);\r\n        }\r\n        return $ok;\r\n    }\r\n\r\n    public static function renderImage(string $code): string\r\n    {\r\n        $width = 130; $height = 42;\r\n        $image = imagecreatetruecolor($width, $height);\r\n        $bg = imagecolorallocate($image, 245, 247, 250);\r\n        imagefilledrectangle($image, 0, 0, $width, $height, $bg);\r\n        for ($i = 0; $i < 5; $i++) {\r\n            $noise = imagecolorallocate($image, rand(150, 220), rand(150, 220), rand(150, 220));\r\n            imageline($image, rand(0, $width), rand(0, $height), rand(0, $width), rand(0, $height), $noise);\r\n        }\r\n        $color = imagecolorallocate($image, 60, 60, 60);\r\n        $x = 12;\r\n        for ($i = 0; $i < strlen($code); $i++) {\r\n            imagestring($image, 5, $x, rand(8, 16), $code[$i], $color);\r\n            $x += 22;\r\n        }\r\n        ob_start();\r\n        imagepng($image);\r\n        imagedestroy($image);\r\n        return (string)ob_get_clean();\r\n    }\r\n\r\n    public static function renderSvg(string $code): string\r\n    {\r\n        $w = 130; $h = 42;\r\n        $bg = '#f5f7fa'; $fg = '#333'; $noise='';\r\n        for ($i = 0; $i < 6; $i++) {\r\n            $x1=rand(0,$w);$y1=rand(0,$h);$x2=rand(0,$w);$y2=rand(0,$h);\r\n            $c=sprintf('#%02x%02x%02x', rand(160,220), rand(160,220), rand(160,220));\r\n            $noise.="<line x1='$x1' y1='$y1' x2='$x2' y2='$y2' stroke='$c' stroke-width='1'/>";\r\n        }\r\n        $chars='';$x=12;\r\n        for ($i=0;$i<strlen($code);$i++){\r\n            $chars.="<text x='$x' y='26' font-size='18' font-family='monospace' fill='$fg' transform='rotate(".rand(-12,12)." $x 26')>".htmlspecialchars($code[$i])."</text>";\r\n            $x+=22;\r\n        }\r\n        return "<svg xmlns='http://www.w3.org/2000/svg' width='$w' height='$h' viewBox='0 0 $w $h'><rect width='100%' height='100%' fill='$bg'/>$noise$chars</svg>";\r\n    }\r\n}\r\n